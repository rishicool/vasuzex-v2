/**
 * {{capitalize appName}} Server
 * Extends BaseServer from framework with database support
 */

import { BaseServer, Facade } from 'vasuzex';
import dotenv from 'dotenv';
import guruorm from 'guruorm';
const { Capsule } = guruorm;
import path from 'path';
import { fileURLToPath } from 'url';
import { createApp as buildApp } from './app.js';

// Load root .env file BEFORE anything else
const projectRoot = process.cwd();
dotenv.config({ path: `${projectRoot}/.env` });

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * {{pascalCase appName}}Server - Extends BaseServer
 */
class {{pascalCase appName}}Server extends BaseServer {
  constructor() {
    super({
      appName: process.env.APP_NAME || '{{appName}}-api',
      projectRoot: projectRoot
    });
    
    this.db = null;
  }

  /**
   * Validate configuration
   */
  validateConfig() {
    // Add your custom config validations here
    super.validateConfig();
  }

  /**
   * Initialize database connection
   */
  async initializeDatabase() {
    try {
      // Use root config (centralized)
      const dbUrl = process.env.DATABASE_URL || 'postgresql://postgres@localhost:5432/{{appName}}_db';
      
      // Create capsule instance (GuruORM)
      const capsule = new Capsule();
      
      // Add PostgreSQL connection
      capsule.addConnection({
        driver: 'pgsql',
        host: process.env.POSTGRES_HOST || 'localhost',
        port: parseInt(process.env.POSTGRES_PORT) || 5432,
        database: process.env.POSTGRES_DB || '{{appName}}_db',
        username: process.env.POSTGRES_USER || 'postgres',
        password: process.env.POSTGRES_PASSWORD || '',
        charset: 'utf8',
        prefix: '',
        schema: 'public',
      });
      
      // Make capsule globally available
      capsule.setAsGlobal();
      capsule.bootEloquent();
      
      // Get DB connection for Facade
      this.db = capsule.connection();
      
      console.log('[{{capitalize appName}}API] üóÑÔ∏è  Database connected');
      
      return this.db;
    } catch (error) {
      console.error('[{{capitalize appName}}API] ‚ùå Database error:', error);
      throw error;
    }
  }

  /**
   * Initialize {{appName}}-specific services
   */
  async initializeServices() {
    try {
      // Add your service initializations here
      console.log('[{{capitalize appName}}API] üì¶ Services initialized');
    } catch (error) {
      console.error('[{{capitalize appName}}API] ‚ùå Services error:', error);
      throw error;
    }
  }

  /**
   * Create Express app
   */
  createApp() {
    return buildApp();
  }

  /**
   * Custom startup tasks
   */
  async onServerStart(server) {
    const port = process.env.APP_PORT || 3000;
    console.log(`üöÄ {{appName}}-api running on http://localhost:${port}`);
  }
}

/**
 * Bootstrap and start server
 */
async function bootstrap() {
  try {
    const server = new {{pascalCase appName}}Server();
    await server.initializeDatabase();
    await server.initializeServices();
    await server.start();
  } catch (error) {
    console.error('‚ùå Failed to start server:', error);
    process.exit(1);
  }
}

// Start server
bootstrap();
