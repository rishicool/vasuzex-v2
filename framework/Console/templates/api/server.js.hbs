/**
 * {{capitalize appName}} API Server
 * Extends BaseServer - Database is centralized in @{{projectName}}/database
 */

import { BaseServer } from 'vasuzex';
import dotenv from 'dotenv';
import { createApp as buildApp } from './app.js';

// Import centralized database (triggers connection automatically)
import '@{{projectName}}/database';

// Load root .env file
const projectRoot = process.cwd();
dotenv.config({ path: `${projectRoot}/.env` });

/**
 * {{pascalCase appName}}Server - Extends BaseServer
 */
class {{pascalCase appName}}Server extends BaseServer {
  constructor() {
    super({
      appName: process.env.APP_NAME || '{{appName}}-api',
      projectRoot: projectRoot
    });
  }

  /**
   * Validate configuration
   */
  validateConfig() {
    const required = ['POSTGRES_HOST', 'POSTGRES_DB', 'POSTGRES_USER'];
    const missing = required.filter(key => !process.env[key]);
    
    if (missing.length > 0) {
      console.error(`‚ùå Missing required environment variables: ${missing.join(', ')}`);
      process.exit(1);
    }
    
    super.validateConfig();
  }

  /**
   * Initialize {{appName}}-specific services
   */
  async initializeServices() {
    try {
      // Add your service initializations here
      // Database is already initialized by importing @{{projectName}}/database
      
      console.log('[{{capitalize appName}}API] üì¶ Services initialized');
    } catch (error) {
      console.error('[{{capitalize appName}}API] ‚ùå Services error:', error);
      throw error;
    }
  }

  /**
   * Create Express app
   */
  createApp() {
    return buildApp();
  }

  /**
   * Custom startup tasks
   */
  async onServerStart(server) {
    const port = process.env.APP_PORT || 3000;
    console.log(`üöÄ {{appName}}-api running on http://localhost:${port}`);
    console.log(`   Database: ${process.env.POSTGRES_DB}@${process.env.POSTGRES_HOST}`);
  }
}

/**
 * Bootstrap and start server
 */
async function bootstrap() {
  try {
    const server = new {{pascalCase appName}}Server();
    await server.initializeServices();
    await server.start();
  } catch (error) {
    console.error('‚ùå Failed to start server:', error);
    process.exit(1);
  }
}

// Start server
bootstrap();
